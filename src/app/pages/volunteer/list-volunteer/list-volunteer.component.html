<ion-header>
  <ion-toolbar mode="ios">
    <ion-buttons slot="start">
      <ion-back-button color="dark" class="show-back-button" defaultHref="home"></ion-back-button>
    </ion-buttons>
    <ion-buttons slot="end">
      <ion-menu-button color="dark"></ion-menu-button>
    </ion-buttons>
    <img src="../../assets/images/DSU.png" class="logo-title mx-auto" />
  </ion-toolbar>
</ion-header>

<ion-content padding>
  <ion-refresher slot="fixed" (ionRefresh)="doRefresh($event)">
    <ion-refresher-content></ion-refresher-content>
  </ion-refresher>

  <div class="selectors">
    <div class="mt-10 clear-selector">
      <ion-label class="title">
        Alege județ
      </ion-label>
      <ion-select class="mt-10" [(ngModel)]="selectedCounty" (ionChange)="selectionsChanged()"
        [ngClass]="{'selector-active': selectedCounty}" (click)="filterModal(counties, $event, 'county')">
        <ion-select-option *ngFor="let county of [selectedCounty]" [value]="county">{{county?.name}}</ion-select-option>
      </ion-select>
      <ion-button float-right color="light" *ngIf="selectedCounty" (click)="selectedCounty = null">
        <ion-icon name="close"></ion-icon>
      </ion-button>
    </div>

    <div class="mt-10 clear-selector">
      <ion-label class="title">
        Alege organizație
      </ion-label>
      <ion-select class="mt-10" [(ngModel)]="selectedOrganisation" (ionChange)="selectionsChanged()"
        [ngClass]="{'selector-active': selectedOrganisation}"
        (click)="filterModal(organisations, $event, 'organisation')">
        <ion-select-option *ngFor="let organisation of [selectedOrganisation]" [value]="organisation">
          {{organisation?.name}}</ion-select-option>
      </ion-select>
      <ion-button color="light" *ngIf="selectedOrganisation" (click)="selectedOrganisation = null">
        <ion-icon name="close"></ion-icon>
      </ion-button>
    </div>

    <div class="mt-10 clear-selector">
      <ion-label class="title">
        Alege specializare
      </ion-label>
      <ion-select class="mt-10" [(ngModel)]="selectedCourse" (ionChange)="selectionsChanged()"
        [ngClass]="{'selector-active': selectedCourse}" (click)="filterModal(courseOptions, $event, 'course')">
        <ion-select-option *ngFor="let course of [selectedCourse]" [value]="course">{{course?.name}}</ion-select-option>
      </ion-select>
      <ion-button float-right color="light" *ngIf="selectedCourse" (click)="selectedCourse = null">
        <ion-icon name="close"></ion-icon>
      </ion-button>
    </div>
  </div>

  <ion-list class="mt-30 pb-0" class="underlined-list">
    <div *ngFor="let volunteer of volunteers" class="list-item">
      <ion-item lines="none" (click)="openMenu(volunteer._id)">
        <ion-label class="name">
          {{volunteer.name}}
        </ion-label>
        <ion-label class="organisation pl-10">
          <a (click)="openBrowser(volunteer.organisation?.website)" *ngIf="volunteer.organisation">
            {{(volunteer.organisation.name)}}
          </a>
          <a *ngIf="!volunteer.organisation">
            Neafiliat
          </a>
        </ion-label>
        <ion-icon name="arrow-dropdown" class="drop-down-icon" *ngIf="volunteer._id !== volunteerIdWithDetails">
        </ion-icon>
        <ion-icon name="arrow-dropup" class="drop-down-icon" *ngIf="volunteer._id === volunteerIdWithDetails">
        </ion-icon>
      </ion-item>

      <div *ngIf="volunteer._id === volunteerIdWithDetails" class="item-menu mb-5">
        <ion-item lines="none" *ngFor="let course of volunteer.courses">
          <ion-label class="m-0">
            Voluntar acreditat pentru <a>{{course.course_name?.name}}</a>.
          </ion-label>
        </ion-item>

        <ion-item lines="none" *ngIf="allocation">
          <ion-label class="m-0">
            Ultima alocare {{ allocation?.city?.name }}, {{ allocation?.county?.name}}.
          </ion-label>
        </ion-item>

        <ion-item lines="none" *ngIf="volunteer.job">
          <ion-label class="m-0">
            {{volunteer.job}}.
          </ion-label>
        </ion-item>

        <ion-item lines="none">
          <ion-label class="m-0">
            Înregistrat în {{volunteer.created_at | date: 'dd.MM.yyyy'}}.
          </ion-label>
        </ion-item>

        <ion-row lines="none" *ngIf="!volunteer.isInAllocation">
          <ion-col col-6>
            <ion-button color="light" class="w-100" (click)="sendAlert(volunteer)">
              Trimite mesaj
            </ion-button>
          </ion-col>
          <ion-col col-6 *ngIf="!volunteer.allocation" (click)="allocateUser(volunteer._id)">
            <ion-button color="secondary" class="w-100">
              Alocă voluntar
            </ion-button>
          </ion-col>
          <ion-col col-6 *ngIf="volunteer.allocation" (click)="allocateUser(volunteer._id)">
            <ion-button color="light" class="w-100">
              Voluntar alocat
            </ion-button>
          </ion-col>
        </ion-row>

        <div *ngIf="volunteer.isInAllocation">
          <ion-row>
            <ion-col col-6 class="custom-input selectors">
              <ion-label class="title">Județ</ion-label>
              <ion-select [(ngModel)]="county" class="mt-5 p-5" (ionChange)="getCitiesList()"
                (click)="allocationModal(counties, $event, 'county')">
                <ion-select-option *ngFor="let county of [county]" [value]="county">{{county?.name}}</ion-select-option>
              </ion-select>
            </ion-col>
            <ion-col col-6 class="custom-input selectors">
              <ion-label class="title">Localitate</ion-label>
              <ion-select [(ngModel)]="city" class="mt-5 p-5" (click)="allocationModal(cities, $event, 'city')"
                [disabled]="cities.length === 0">
                <ion-select-option *ngFor="let city of [city]" [value]="city">{{city?.name}}</ion-select-option>
              </ion-select>
            </ion-col>
          </ion-row>
          <ion-row>
            <ion-col col-6>
              <ion-button color="success" (click)="confirmAllocation(volunteer._id)" class="w-100 h-25">
                Confirmă
              </ion-button>
            </ion-col>
            <ion-col col-6>
              <ion-button color="danger" (click)="cancelAllocation(volunteer._id)" class="w-100 h-25">
                Anulează
              </ion-button>
            </ion-col>
          </ion-row>
        </div>
      </div>
    </div>
  </ion-list>

  <ion-infinite-scroll threshold="100px" (ionInfinite)="loadData($event)">
    <ion-infinite-scroll-content loadingSpinner="bubbles" loadingText="Se încarcă voluntari...">
    </ion-infinite-scroll-content>
  </ion-infinite-scroll>

  <ion-row *ngIf="volunteers.length > 0">
    <ion-col col-6></ion-col>
    <ion-col col-6 align-self-end>
      <ion-button color="secondary" (click)="sendAlert()" float-right class="w-100">
        Trimite-le alertă
      </ion-button>
    </ion-col>
  </ion-row>

</ion-content>